<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supermercado Inclusivo</title>
    <style>
         :root {
            --brand: #2e7d32;
            /* verde */
            --brand-2: #ff9800;
            /* naranja */
            --ink: #222;
            --bg: #f7f7f7;
        }
        
        * {
            box-sizing: border-box
        }
        
        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--ink)
        }
        
        header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--brand);
            color: #fff;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px
        }
        
        header h1 {
            font-size: 20px;
            margin: 0;
            flex: 1
        }
        
        .search {
            flex: 2;
            max-width: 560px
        }
        
        .search input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: none
        }
        
        .container {
            padding: 16px
        }
        
        .toolbar {
            display: flex;
            gap: 8px;
            overflow: auto;
            padding: 8px 16px;
            background: #fff;
            border-bottom: 1px solid #eaeaea
        }
        
        .chip {
            flex: 0 0 auto;
            background: #e8f5e9;
            color: #1b5e20;
            border: 1px solid #c8e6c9;
            padding: 10px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600
        }
        
        .chip[aria-selected="true"] {
            background: var(--brand);
            color: #fff;
            border-color: var(--brand)
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 14px;
            padding: 16px
        }
        
        .card {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
            overflow: hidden;
            display: flex;
            flex-direction: column
        }
        
        .card img {
            width: 100%;
            height: 140px;
            object-fit: cover
        }
        
        .card .body {
            padding: 10px 12px;
            display: grid;
            gap: 6px
        }
        
        .price {
            font-weight: 800
        }
        
        .btn {
            background: var(--brand-2);
            color: #fff;
            border: none;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700
        }
        
        .btn:active {
            transform: scale(.98)
        }
        /* carrito */
        
        .cart {
            position: fixed;
            right: 12px;
            bottom: 12px;
            width: 320px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .12);
            overflow: hidden
        }
        
        .cart header {
            position: static;
            background: #fff;
            color: var(--ink);
            padding: 12px 14px;
            border-bottom: 1px solid #eee
        }
        
        .cart header h3 {
            margin: 0;
            font-size: 16px
        }
        
        .cart .items {
            padding: 10px;
            overflow: auto;
            flex: 1
        }
        
        .item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 6px;
            border-bottom: 1px dashed #eee
        }
        
        .item .qty {
            display: flex;
            align-items: center;
            gap: 6px
        }
        
        .item button {
            background: #eee;
            border: none;
            border-radius: 8px;
            padding: 4px 8px;
            cursor: pointer
        }
        
        .cart .foot {
            padding: 12px 14px;
            border-top: 1px solid #eee;
            display: grid;
            gap: 8px
        }
        
        .total {
            display: flex;
            justify-content: space-between;
            font-weight: 800
        }
        
        .checkout {
            background: var(--brand);
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer
        }
        /* login y senior */
        
        #loginPage {
            min-height: 100dvh;
            display: grid;
            place-items: center;
            padding: 24px
        }
        
        .login-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .1);
            padding: 20px;
            max-width: 420px;
            width: 100%;
            display: grid;
            gap: 12px
        }
        
        .login-card input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px
        }
        
        .login-card button {
            background: var(--brand);
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer
        }
        
        #mainPage {
            display: none
        }
        
        #seniorPage {
            display: none
        }
        
        .senior {
            min-height: 100dvh;
            background: #000;
            color: #fff;
            display: grid;
            place-items: center;
            padding: 24px
        }
        
        .senior .panel {
            background: #111;
            border: 2px solid #ffd54f;
            border-radius: 20px;
            padding: 24px;
            display: grid;
            gap: 16px;
            text-align: center
        }
        
        .senior .panel h1 {
            font-size: 28px;
            margin: 0
        }
        
        .senior .panel p {
            font-size: 20px;
            margin: 0
        }
        
        .senior .big {
            font-size: 22px;
            padding: 18px 24px;
            border-radius: 16px;
            border: none;
            background: #ffcc00;
            color: #000;
            cursor: pointer;
            font-weight: 900
        }
        /* modal pago */
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px
        }
        
        .sheet {
            background: #fff;
            max-width: 560px;
            width: 100%;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .2);
            overflow: hidden
        }
        
        .sheet header {
            background: #fafafa;
            border-bottom: 1px solid #eee;
            color: var(--ink)
        }
        
        .sheet .body {
            padding: 16px;
            display: grid;
            gap: 12px
        }
        
        .pay-row {
            display: flex;
            gap: 10px;
            align-items: center
        }
        
        .pay-row input {
            scale: 1.3
        }
        
        .close {
            background: #eee;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer
        }
        
        .mini {
            font-size: 12px;
            color: #666
        }
        /* ayuda flotante */
        
        .help-btn {
            position: fixed;
            bottom: 14px;
            left: 14px;
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 14px 16px;
            font-weight: 800;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .2);
            cursor: pointer
        }
        /* Historial */
        
        #historyBtn {
            margin-left: 8px;
            background: #455a64
        }
        
        .history {
            display: none;
            padding: 12px
        }
        
        .history h3 {
            margin: 8px 0
        }
        
        .order {
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, .06)
        }
        
        .order small {
            color: #666
        }
        /* responsive */
        
        @media (max-width: 820px) {
            .cart {
                left: 12px;
                right: 12px;
                bottom: 12px;
                width: auto
            }
            .grid {
                grid-template-columns: repeat(2, 1fr)
            }
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div id="loginPage">
        <div class="login-card">
            <h2>Bienvenido a ORBEX</h2>
            <input id="name" type="text" placeholder="Nombre" />
            <input id="age" type="number" placeholder="Edad" />
            <button onclick="login()">Entrar</button>
            <small>¿Necesitas ayuda? Te acompañamos durante la compra.</small>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="mainPage">
        <header>
            <h1>ORBEX</h1>
            <div class="search"><input id="search" placeholder="Buscar productos..." /></div>
            <button id="historyBtn" class="btn" onclick="toggleHistory()">Historial</button>
        </header>

        <!-- categorías -->
        <nav class="toolbar" id="toolbar"></nav>

        <!-- catálogo -->
        <section class="grid" id="catalog"></section>

        <!-- carrito -->
        <aside class="cart" aria-live="polite">
            <header>
                <h3>🛒 Carrito</h3>
            </header>
            <div class="items" id="cartItems"></div>
            <div class="foot">
                <div class="total"><span>Subtotal</span><span id="cartTotal">$0</span></div>
                <button class="checkout" onclick="openCheckout()">Finalizar compra</button>
            </div>
        </aside>

        <button class="help-btn" onclick="callHelp()">📞 Ayuda</button>

        <!-- HISTORIAL -->
        <section id="history" class="history">
            <h3>Historial de pedidos</h3>
            <div id="historyList"></div>
        </section>
    </div>

    <!-- PÁGINA ADULTOS MAYORES -->
    <div id="seniorPage" class="senior">
        <div class="panel">
            <h1>Atención Especial para Adultos Mayores</h1>
            <p>Podemos tomar su pedido por teléfono o ayudarle paso a paso.</p>
            <button class="big" onclick="callHelp()">📞 Llamar ahora</button>
            <button class="big" onclick="enterSimplified()">🛒 Ver catálogo simplificado</button>
        </div>
    </div>

    <!-- MODAL DE PAGO -->
    <div id="payModal" class="modal" role="dialog" aria-modal="true">
        <div class="sheet">
            <header>
                <h2 style="margin:0;padding:12px 16px">Finalizar compra</h2>
            </header>
            <div class="body">
                <div class="total" style="margin-bottom:6px"><span>Subtotal</span><span id="paySubtotal">$0</span></div>

                <label>Zona de entrega</label>
                <select id="zone" onchange="recalc()" style="padding:10px;border:1px solid #ddd;border-radius:10px">
        <option value="centro">Centro (+$3.000)</option>
        <option value="norte">Norte (+$5.000)</option>
        <option value="sur">Sur (+$4.000)</option>
      </select>
                <div class="mini">El costo de domicilio se suma al total.</div>

                <label>Cupón de descuento</label>
                <input id="coupon" placeholder="Ej: BIENVENIDO10, ENVIOGRATIS" oninput="recalc()" style="padding:10px;border:1px solid #ddd;border-radius:10px" />
                <div id="couponMsg" class="mini"></div>

                <label>Método de pago</label>
                <label class="pay-row"><input type="radio" name="pay" value="tarjeta" checked /> 💳 Tarjeta (débito/crédito)</label>
                <label class="pay-row"><input type="radio" name="pay" value="transferencia" /> 💸 Transferencia / PSE</label>
                <label class="pay-row"><input type="radio" name="pay" value="billetera" /> 📱 Billetera digital</label>
                <label class="pay-row"><input type="radio" name="pay" value="contraentrega" /> 🚪 Contraentrega (efectivo)</label>

                <input id="address" placeholder="Dirección de entrega" style="padding:10px;border:1px solid #ddd;border-radius:10px" />

                <div class="total"><span>Domicilio</span><span id="payDelivery">$0</span></div>
                <div class="total"><span>Descuento</span><span id="payDiscount">-$0</span></div>
                <div class="total" style="font-size:18px"><span>Total a pagar</span><span id="payTotal">$0</span></div>

                <div style="display:flex;gap:8px;justify-content:flex-end">
                    <button class="close" onclick="closeCheckout()">Cancelar</button>
                    <button class="checkout" onclick="confirmOrder()">Confirmar pedido</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======== DATOS DE CATÁLOGO ========
        const productData = {
            "Frutas y Verduras": [{
                name: 'Manzana roja',
                price: 1900,
                img: 'https://upload.wikimedia.org/wikipedia/commons/1/15/Red_Apple.jpg'
            }, {
                name: 'Banano',
                price: 900,
                img: 'https://upload.wikimedia.org/wikipedia/commons/8/8a/Banana-Single.jpg'
            }, {
                name: 'Tomate',
                price: 1400,
                img: 'https://upload.wikimedia.org/wikipedia/commons/8/89/Tomato_je.jpg'
            }],
            "Carnes y Pescados": [{
                name: 'Punta de anca (500g)',
                price: 16500,
                img: 'https://upload.wikimedia.org/wikipedia/commons/4/48/Raw_red_meat.png'
            }, {
                name: 'Pechuga de pollo (500g)',
                price: 9800,
                img: 'https://upload.wikimedia.org/wikipedia/commons/5/5f/Chicken_breast.png'
            }, {
                name: 'Filete de tilapia (300g)',
                price: 12900,
                img: 'https://upload.wikimedia.org/wikipedia/commons/7/70/Fish_fillet.jpg'
            }],
            "Panadería": [{
                name: 'Pan francés (6u)',
                price: 3200,
                img: 'https://upload.wikimedia.org/wikipedia/commons/b/bc/French_bread.jpg'
            }, {
                name: 'Croissant',
                price: 2800,
                img: 'https://upload.wikimedia.org/wikipedia/commons/6/6f/Croissant-Petr_Kratochvil.jpg'
            }, {
                name: 'Torta vainilla',
                price: 12900,
                img: 'https://upload.wikimedia.org/wikipedia/commons/5/5a/Vanilla_cake.jpg'
            }],
            "Lácteos y Huevos": [{
                name: 'Leche 1L',
                price: 3600,
                img: 'https://upload.wikimedia.org/wikipedia/commons/1/19/Glass_of_milk_on_table.jpg'
            }, {
                name: 'Queso campesino (250g)',
                price: 7800,
                img: 'https://upload.wikimedia.org/wikipedia/commons/4/4c/Cheese.jpg'
            }, {
                name: 'Huevo AA (12u)',
                price: 9800,
                img: 'https://upload.wikimedia.org/wikipedia/commons/7/7b/Chicken_egg.jpg'
            }],
            "Bebidas": [{
                name: 'Agua 600ml',
                price: 1800,
                img: 'https://upload.wikimedia.org/wikipedia/commons/a/a2/Water_bottle.png'
            }, {
                name: 'Jugo de naranja',
                price: 5200,
                img: 'https://upload.wikimedia.org/wikipedia/commons/7/7b/Orange_juice_1.jpg'
            }, {
                name: 'Gaseosa 1.5L',
                price: 7200,
                img: 'https://upload.wikimedia.org/wikipedia/commons/0/05/Soft_drink_glass.jpg'
            }],
            "Aseo y Limpieza": [{
                name: 'Detergente 1kg',
                price: 9800,
                img: 'https://upload.wikimedia.org/wikipedia/commons/1/1b/Washing_powder.jpg'
            }, {
                name: 'Jabón tocador',
                price: 2300,
                img: 'https://upload.wikimedia.org/wikipedia/commons/4/4e/Soap_bar.jpg'
            }, {
                name: 'Cloro 1L',
                price: 6500,
                img: 'https://upload.wikimedia.org/wikipedia/commons/1/1b/Bleach_bottle.jpg'
            }],
            "Congelados": [{
                name: 'Helado vainilla',
                price: 8900,
                img: 'https://upload.wikimedia.org/wikipedia/commons/a/a7/Vanilla_ice_cream_cone_%28cropped%29.jpg'
            }, {
                name: 'Verduras mixtas',
                price: 5600,
                img: 'https://upload.wikimedia.org/wikipedia/commons/6/6f/Mixed_vegetables_frozen.jpg'
            }, {
                name: 'Pizza congelada',
                price: 13900,
                img: 'https://upload.wikimedia.org/wikipedia/commons/6/69/Frozen_pizza_2.jpg'
            }],
            "Snacks y Golosinas": [{
                name: 'Papas fritas',
                price: 4200,
                img: 'https://upload.wikimedia.org/wikipedia/commons/6/69/Potato-Chips.jpg'
            }, {
                name: 'Chocolate barra',
                price: 3500,
                img: 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chocolate_%28blue_background%29.jpg'
            }, {
                name: 'Galletas',
                price: 2900,
                img: 'https://upload.wikimedia.org/wikipedia/commons/5/5a/Assorted_cookies.jpg'
            }],
            "Cuidado Personal": [{
                name: 'Shampoo 400ml',
                price: 9200,
                img: 'https://upload.wikimedia.org/wikipedia/commons/d/d8/Shampoo.jpg'
            }, {
                name: 'Crema dental',
                price: 5400,
                img: 'https://upload.wikimedia.org/wikipedia/commons/1/1a/Toothpasteonbrush.jpg'
            }, {
                name: 'Afeitadora',
                price: 7500,
                img: 'https://upload.wikimedia.org/wikipedia/commons/7/7d/Safety_razor.jpg'
            }],
            "Mascotas": [{
                name: 'Concentrado perro 1kg',
                price: 12500,
                img: 'https://upload.wikimedia.org/wikipedia/commons/5/50/Dog_Food.jpg'
            }, {
                name: 'Arena para gato',
                price: 11900,
                img: 'https://upload.wikimedia.org/wikipedia/commons/4/41/Cat_litter.jpg'
            }, {
                name: 'Snacks felinos',
                price: 6900,
                img: 'https://upload.wikimedia.org/wikipedia/commons/1/1a/Cat_treats.jpg'
            }]
        };

        // ======== ESTADO ========
        let currentCategory = Object.keys(productData)[0];
        let cart = [];
        let user = {
            name: "",
            age: 0
        };
        let orders = JSON.parse(localStorage.getItem('orders') || '[]');

        const deliveryByZone = {
            centro: 3000,
            norte: 5000,
            sur: 4000
        };

        // ======== LOGIN ========
        function login() {
            const name = document.getElementById('name').value.trim();
            const age = parseInt(document.getElementById('age').value, 10);
            if (!name || !age) {
                alert('Por favor ingresa tu nombre y edad');
                return;
            }
            user = {
                name,
                age
            };
            document.getElementById('loginPage').style.display = 'none';
            if (age >= 65) {
                document.getElementById('seniorPage').style.display = 'grid';
            } else {
                document.getElementById('mainPage').style.display = 'block';
                bootApp();
            }
        }

        // ======== INICIAR APP ========
        function bootApp() {
            buildToolbar();
            renderCatalog();
            renderHistory();
            document.getElementById('search').addEventListener('input', e => {
                renderCatalog(e.target.value.toLowerCase());
            });
        }

        function enterSimplified() {
            document.getElementById('seniorPage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            bootApp();
        }

        // ======== CATEGORÍAS ========
        function buildToolbar() {
            const toolbar = document.getElementById('toolbar');
            toolbar.innerHTML = '';
            Object.keys(productData).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'chip';
                btn.textContent = cat;
                btn.setAttribute('aria-selected', cat === currentCategory);
                btn.onclick = () => {
                    currentCategory = cat;
                    highlightToolbar();
                    renderCatalog();
                };
                toolbar.appendChild(btn);
            });
        }

        function highlightToolbar() {
            const buttons = document.querySelectorAll('.chip');
            buttons.forEach(b => b.setAttribute('aria-selected', b.textContent === currentCategory));
        }

        // ======== CATÁLOGO ========
        function renderCatalog(query = "") {
            const list = document.getElementById('catalog');
            list.innerHTML = '';
            const products = productData[currentCategory].filter(p => p.name.toLowerCase().includes(query));
            products.forEach(p => {
                const card = document.createElement('article');
                card.className = 'card';
                card.innerHTML = `
        <img src="${p.img}" alt="${p.name}" />
        <div class="body">
          <strong>${p.name}</strong>
          <span class="price">$${p.price.toLocaleString()}</span>
          <button class="btn" onclick='addToCart(${JSON.stringify(p)})'>Agregar</button>
        </div>`;
                list.appendChild(card);
            });
        }

        // ======== CARRITO ========
        function addToCart(p) {
            const existing = cart.find(i => i.name === p.name);
            if (existing) {
                existing.qty += 1;
            } else {
                cart.push({...p,
                    qty: 1
                });
            }
            renderCart();
        }

        function changeQty(name, delta) {
            const i = cart.findIndex(it => it.name === name);
            if (i > -1) {
                cart[i].qty += delta;
                if (cart[i].qty <= 0) cart.splice(i, 1);
                renderCart();
            }
        }

        function cartSubtotal() {
            return cart.reduce((acc, it) => acc + it.price * it.qty, 0);
        }

        function renderCart() {
            const box = document.getElementById('cartItems');
            box.innerHTML = '';
            cart.forEach(it => {
                const row = document.createElement('div');
                row.className = 'item';
                row.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:700">${it.name}</div>
          <div>$${(it.price*it.qty).toLocaleString()} <small>($${it.price.toLocaleString()} c/u)</small></div>
        </div>
        <div class="qty">
          <button onclick="changeQty('${it.name}',-1)">-</button>
          <strong>${it.qty}</strong>
          <button onclick="changeQty('${it.name}',1)">+</button>
        </div>`;
                box.appendChild(row);
            });
            document.getElementById('cartTotal').textContent = `$${cartSubtotal().toLocaleString()}`;
        }

        // ======== CUPONES / ENVÍO ========
        function zoneFee(zone) {
            return deliveryByZone[zone] || 0;
        }

        function couponDiscount(code, subtotal) {
            if (!code) return 0;
            const c = code.trim().toUpperCase();
            if (c === 'BIENVENIDO10') return subtotal * 0.10; // 10% dto
            if (c === 'MAYOR65' && user.age >= 65) return subtotal * 0.08; // 8% dto para mayores
            if (c === 'ENVIOGRATIS') return Math.min(zoneFee(getZone()), 5000); // cubre envío hasta $5.000
            return 0;
        }

        function getZone() {
            return document.getElementById('zone').value;
        }

        // ======== CHECKOUT ========
        function openCheckout() {
            if (cart.length === 0) {
                alert('Tu carrito está vacío');
                return;
            }
            document.getElementById('paySubtotal').textContent = `$${cartSubtotal().toLocaleString()}`;
            document.getElementById('payModal').style.display = 'flex';
            recalc();
        }

        function closeCheckout() {
            document.getElementById('payModal').style.display = 'none';
        }

        function getPaymentMethod() {
            return [...document.querySelectorAll('input[name="pay"]')].find(r => r.checked).value || 'tarjeta';
        }

        function recalc() {
            const subtotal = cartSubtotal();
            const zone = getZone();
            const delivery = zoneFee(zone);
            const code = document.getElementById('coupon').value;
            let discount = couponDiscount(code, subtotal);

            // Si el cupón es ENVIOGRATIS, mostrar mensaje especial
            const msg = document.getElementById('couponMsg');
            msg.textContent = '';
            if (code.trim().toUpperCase() === 'ENVIOGRATIS') {
                msg.textContent = 'Cupón aplicado: envío gratis hasta $5.000';
            } else if (code.trim().toUpperCase() === 'BIENVENIDO10') {
                msg.textContent = 'Cupón aplicado: 10% descuento';
            } else if (code.trim().toUpperCase() === 'MAYOR65' && user.age >= 65) {
                msg.textContent = 'Cupón aplicado: 8% descuento para mayores de 65';
            }

            // Aplicación del descuento de ENVIOGRATIS: se limita al costo de envío
            let deliveryShown = delivery;
            if (code.trim().toUpperCase() === 'ENVIOGRATIS') {
                const envioDescontado = Math.min(delivery, 5000);
                discount = envioDescontado; // tratamos como descuento total
                deliveryShown = Math.max(0, delivery - envioDescontado);
            }

            const total = Math.max(0, subtotal + delivery - discount);
            document.getElementById('paySubtotal').textContent = `$${subtotal.toLocaleString()}`;
            document.getElementById('payDelivery').textContent = `$${deliveryShown.toLocaleString()}`;
            document.getElementById('payDiscount').textContent = `-$${discount.toLocaleString()}`;
            document.getElementById('payTotal').textContent = `$${total.toLocaleString()}`;
        }

        function confirmOrder() {
            const method = getPaymentMethod();
            const addr = (document.getElementById('address').value || '').trim();
            if (!addr) {
                alert('Por favor ingresa una dirección de entrega');
                return;
            }

            // calcular totales finales con el estado actual del modal
            const subtotal = cartSubtotal();
            const zone = getZone();
            const delivery = zoneFee(zone);
            const code = document.getElementById('coupon').value;
            let discount = couponDiscount(code, subtotal);
            if (code.trim().toUpperCase() === 'ENVIOGRATIS') {
                discount = Math.min(delivery, 5000);
            }
            const total = Math.max(0, subtotal + delivery - discount);
            const order = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                user,
                method,
                addr,
                zone,
                items: cart.map(({
                    name,
                    price,
                    qty
                }) => ({
                    name,
                    price,
                    qty
                })),
                subtotal,
                delivery,
                discount,
                total,
                coupon: code.trim().toUpperCase() || null
            };
            orders.unshift(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            alert(`Pedido confirmado\nCliente: ${user.name}\nMétodo: ${method.toUpperCase()}\nTotal: $${total.toLocaleString()}${method==='contraentrega' ? '\nPaga en efectivo al recibir.' : ''}`);

            // limpiar carrito
            cart = [];
            renderCart();
            closeCheckout();
            renderHistory();
        }

        // ======== HISTORIAL ========
        function toggleHistory() {
            const sec = document.getElementById('history');
            sec.style.display = sec.style.display === 'block' ? 'none' : 'block';
        }

        function renderHistory() {
            const box = document.getElementById('historyList');
            box.innerHTML = '';
            if (!orders.length) {
                box.innerHTML = '<p class="mini">Aún no hay pedidos.</p>';
                return;
            }
            orders.forEach(o => {
                const div = document.createElement('div');
                div.className = 'order';
                const items = o.items.map(i => `${i.qty}× ${i.name}`).join(', ');
                div.innerHTML = `
        <strong>Pedido #${o.id}</strong> <small>(${o.date})</small><br>
        <small>${items}</small>
        <div class="total"><span>Total</span><span>$${o.total.toLocaleString()}</span></div>
        <div class="mini">Pago: ${o.method.toUpperCase()} • Zona: ${o.zone} ${o.coupon? '• Cupón: '+o.coupon:''}</div>
      `;
                box.appendChild(div);
            });
        }

        // ======== AYUDA ========
        function callHelp() {
            alert('Llamando al servicio de asistencia del supermercado...');
        }

        // ======== TECLA FLECHA IZQUIERDA (volver) ========
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                history.back();
            }
        });
    </script>
</body>

</html>